version: '3.8'

services:
  # Directus Backend
  directus:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/imobi-directus:latest
    ports:
      - "8055:8055"
    environment:
      # Secret Management
      SECRET: ${DIRECTUS_SECRET}
      
      # Database (RDS PostgreSQL)
      DB_CLIENT: pg
      DB_HOST: ${RDS_ENDPOINT}
      DB_PORT: ${RDS_PORT:-5432}
      DB_DATABASE: ${RDS_DATABASE}
      DB_USER: ${RDS_USERNAME}
      DB_PASSWORD: ${RDS_PASSWORD}
      DB_SSL: ${RDS_SSL:-true}
      
      # Cache (ElastiCache Redis)
      CACHE_ENABLED: true
      CACHE_STORE: redis
      CACHE_AUTO_PURGE: true
      REDIS: ${ELASTICACHE_ENDPOINT}
      
      # Admin
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      
      # WebSocket
      WEBSOCKETS_ENABLED: true
      
      # URLs
      PUBLIC_URL: ${PUBLIC_URL}
      
      # CORS
      CORS_ENABLED: true
      CORS_ORIGIN: ${CORS_ORIGIN}
      
      # Storage (S3)
      STORAGE_LOCATIONS: s3
      STORAGE_S3_DRIVER: s3
      STORAGE_S3_KEY: ${AWS_S3_ACCESS_KEY}
      STORAGE_S3_SECRET: ${AWS_S3_SECRET_KEY}
      STORAGE_S3_BUCKET: ${AWS_S3_BUCKET}
      STORAGE_S3_REGION: ${AWS_REGION}
      STORAGE_S3_ENDPOINT: https://s3.${AWS_REGION}.amazonaws.com
      
      # Logging
      LOG_LEVEL: info
      LOG_STYLE: json
      
      # Email (SES)
      EMAIL_TRANSPORT: smtp
      EMAIL_SMTP_HOST: ${SES_SMTP_HOST}
      EMAIL_SMTP_PORT: ${SES_SMTP_PORT:-587}
      EMAIL_SMTP_USER: ${SES_SMTP_USER}
      EMAIL_SMTP_PASSWORD: ${SES_SMTP_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM}
      
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8055/server/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    logging:
      driver: awslogs
      options:
        awslogs-group: /ecs/imobi-directus
        awslogs-region: ${AWS_REGION}
        awslogs-stream-prefix: directus

  # Next.js Frontend
  frontend:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/imobi-frontend:latest
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${PUBLIC_URL}
      PORT: 3000
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    logging:
      driver: awslogs
      options:
        awslogs-group: /ecs/imobi-frontend
        awslogs-region: ${AWS_REGION}
        awslogs-stream-prefix: frontend
